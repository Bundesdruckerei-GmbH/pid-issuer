/*
 * Copyright Bundesdruckerei 2024. Licensed under EUPL-1.2, see the accompanying license file.
 */
package de.bundesdruckerei.mdoc.kotlin.core.auth

import com.upokecenter.cbor.CBORObject
import de.bundesdruckerei.mdoc.kotlin.core.common.toByteArray
import de.bundesdruckerei.mdoc.kotlin.sortIssuerSignedNameSpacesData
import de.bundesdruckerei.mdoc.kotlin.test.Data

import org.junit.Assert.assertEquals
import org.junit.Before
import org.junit.Test

class IssuerSignedTest {
    private val issuerSignedByteString =
        "a26a697373756572417574688443a10126a1182159021d30820219308201bfa00302010202046491763b300a06082a8648ce3d040302303d310b3009060355040613024445312e302c06035504030c2542445220494143412049534f2f4945432031383031332d3520763120544553542d4f4e4c59301e170d3233303632303039343934375a170d3234303931323039343934375a303b310b3009060355040613024445312c302a06035504030c234244522044532049534f2f4945432031383031332d3520763120544553542d4f4e4c593059301306072a8648ce3d020106082a8648ce3d030107034200047bcbbdccce7b65047e871ab9fc93cbec15fbce1549c16c1af3735154233a487d1d1917fb328e74b420d0c830ccf0e0998fac701f788ddd4606dc41543f2079cca381ae3081ab300e0603551d0f0101ff04040302078030150603551d250101ff040b3009060728818c5d050102301d0603551d120416301481126d646c2d6578616d706c65406264722e646530230603551d1f041c301a3018a016a01482126d646c2e6578616d706c652e6264722e6465301f0603551d23041830168014978a573488ff09233ba01fde79839be127294069301d0603551d0e041604145fcbc262ec718ebdee9be09d5784cc22a51242c5300a06082a8648ce3d0403020348003045022021de424b4a8cbf4df3c9009769be2b0eecae8af6e327eb89e3d8e1e880ae1ec6022100df9dd6a54dbbb208fed003e555e382a10338f006d52e5e91f6ba287662bdd766590409d818590404a667646f6354797065756f72672e69736f2e31383031332e352e312e6d444c6776657273696f6e63312e306c76616c6964697479496e666fa3667369676e6564c074323032332d30372d31345431313a35383a34315a6976616c696446726f6dc074323032332d30372d31345431313a35383a34315a6a76616c6964556e74696cc074323032342d30372d31335431313a35383a34315a6c76616c756544696765737473a2716f72672e69736f2e31383031332e352e31b2045820f1e07454f2129fe1147d53e637400b124eae8103a4815087806bf2ad204baaed18af5820ebb63efffbaa84f370e10b9af0bc4d6bc385bd740600973e285cd5f397402c0c18ce5820571258d14efd85941d59fe5b1ff33f1fd856a18648b63701d0afce3bd5232e12184f58204d8b10fb95353b4167552b9540c52a71460835ad422c5e0cf6397c7f0ee5007b19018b582073f69cb02bdde473de562588457867dcb83a5f555eccb1c9a0f47ca7a4fcacbe19019558203e2f318e4b6e33a96c8c1ebdce2667115ae1fb55f4c1735581a3d73fb4462e0a190298582016ad012ea76aeb2fc1af82f554e87f932cb6ffaabb831df64d51d536182d656e1902c7582013a42c15c9caf72ce907afd6d4d6c5077723f4bd09015be5ddf0688efb32bd591902cb5820dc254bec4acf9c2a02f065ca9dc4f9a6a927cd5f7a0400974c2fd52659b7604d1902d75820d22773e22d58e40cd72bdd19772cef75b50fb32b9d1534ac16521f866ec4b8a319020d582007700a85105df38625c25a75c681a565eb1e2877326d6e69208710da73eb9be41902485820b402f9fbda2fe5b5138a9fa6a9c954db26434dd547bf0dc568b9588fe746c2241903895820b3a2336259f9b53f3801b66b5cfe2b2295305bfb91ca0568614adf6e031e08db1903c45820aab790681c597e045aec81c0b31a9033240f5dcd0f9102a3633dd258a475fdc31903d958209b4f3a8dc6a52946e3a8f71ab371fc1948b36aea8b90ad31c721f68a7fad8ec61903185820a66fac9f1226e69b1caf85ee8a347da6d95a074f5ed42e38c4cbe5d433645348190322582073c562cf3db521bcc4c9c503b714e11f9c5306331521aaad770e022a81b6c7f619036258204f3749e62b0f0b83bdf9802278fd0837bff414a51e3e6d61b098fdc04f797665746f72672e69736f2e31383031332e352e312e4445a1190303582009c3a3e1faa0bd1fe459906a5fe5e2e37a6e65fb8b359eb581c585234f02f1bd6d6465766963654b6579496e666fa1696465766963654b6579a401022001215820c4a8287222225a394ba26100ec3a35ab25ba02ed932f6eea30c87bd3dc3bb75e22582040cd9816974f7a59a7bd5268861c0d7da17e8514ccbb8abf99b100df66d80c3a6f646967657374416c676f726974686d675348412d32353658404dfc813b35635128391affd0140a1abc9049e9d49fd2e84aec0edac2023c083efb1bfdcea13cce08ef7d28d679c228f9fb64d60fc0faa4e258b49b6454c02a096a6e616d65537061636573a1716f72672e69736f2e31383031332e352e318fd818585ba46672616e646f6d5037ca06e317b14f253b116023857de55f6864696765737449441902df6c656c656d656e7456616c75656a4d75737465726d616e6e71656c656d656e744964656e7469666965726b66616d696c795f6e616d65d8185855a46672616e646f6d5037ca06e687b14f253b116023857de55f68646967657374494419020d6c656c656d656e7456616c7565654572696b6171656c656d656e744964656e7469666965726a676976656e5f6e616d65d818585aa46672616e646f6d50e6f4f72d13ac3b3f8807beadb51021926864696765737449441900646c656c656d656e7456616c75656a313439322d31322d303671656c656d656e744964656e7469666965726a62697274685f64617465d818585aa46672616e646f6d50e6f4f72d13fc3b3f8807bcadb51021926864696765737449441900676c656c656d656e7456616c75656a323031382d31322d303671656c656d656e744964656e7469666965726a69737375655f64617465d818585ba46672616e646f6d50e6f4e72d13ac3b3f8807beadb51023926864696765737449441900786c656c656d656e7456616c75656a323032362d31322d303671656c656d656e744964656e7469666965726b6578706972795f64617465d8185859a46672616e646f6d5037ca06e162b14f253b116023857de55f6864696765737449441a000001ff6c656c656d656e7456616c756562444571656c656d656e744964656e7469666965726f69737375696e675f636f756e747279d8185860a46672616e646f6d5037ca02c162b14f253b116023857de55f6864696765737449441b00000000000002376c656c656d656e7456616c7565634b424171656c656d656e744964656e7469666965727169737375696e675f617574686f72697479d8185861a46672616e646f6d5037ca02c162b14f253b546023857de55f6864696765737449441b00000000000003a96c656c656d656e7456616c75656634343132373271656c656d656e744964656e7469666965726f646f63756d656e745f6e756d626572d818584da46672616e646f6d5037ca02c162b14f268a546023857de55f68646967657374494418fb6c656c656d656e7456616c75656071656c656d656e744964656e74696669657268706f727472616974d81858a7a46672616e646f6d5037ca02c162b14f253b546023857de77e6864696765737449441a000002d96c656c656d656e7456616c756581a36a69737375655f64617465d903ec6a323031392d30362d32356b6578706972795f64617465d903ec6a323032342d30362d32357576656869636c655f63617465676f72795f636f646562434571656c656d656e744964656e7469666965727264726976696e675f70726976696c65676573d818585da46672616e646f6d50012801b53ba39d99da6895a9624fd5d76864696765737449441901076c656c656d656e7456616c7565614471656c656d656e744964656e74696669657276756e5f64697374696e6775697368696e675f7369676ed8185849a46672616e646f6d50e3f4f72d13ac4a2c3407beadb12021926864696765737449441902ed6c656c656d656e7456616c75650171656c656d656e744964656e74696669657263736578d8185865a46672616e646f6d50e6f4e72d13ac3b3f5395beadb51023926864696765737449441901736c656c656d656e7456616c75656a323031342d31302d323471656c656d656e744964656e74696669657275706f7274726169745f636170747572655f64617465d8185856a46672616e646f6d50e3f4f72d13ac4a2f8807beadb120219268646967657374494419031a6c656c656d656e7456616c75651907ba71656c656d656e744964656e7469666965726e6167655f62697274685f79656172d8185853a46672616e646f6d50e3f4f72d13ac3b3f8807beadb12021926864696765737449441a000003d96c656c656d656e7456616c7565f571656c656d656e744964656e7469666965726b6167655f6f7665725f3138"

    private lateinit var issuerSignedCBOR: CBORObject
    private lateinit var issuerSigned: IssuerSigned

    private lateinit var issuerSignedCBORNameSpaces: List<CBORObject>
    private lateinit var issuerSignedNameSpaces: List<CBORObject>

    @Before
    fun setUp() {

        IssuerSignedTest()
        issuerSignedCBOR = CBORObject.DecodeFromBytes(issuerSignedByteString.toByteArray())
        issuerSigned = IssuerSigned.fromCBOR(issuerSignedCBOR)

    }

    @Test
    fun getNameSpaces() {
        assertEquals("[${Data.ItemsRequest.nameSpaceKey}]", issuerSigned.nameSpaces?.keys.toString())
    }

    @Test
    fun asCBOR() {
        assertEquals(issuerSignedCBOR.get("issuerAuth"), issuerSigned.asCBOR().get("issuerAuth"))
        val list = sortIssuerSignedNameSpacesData(issuerSignedCBOR, issuerSigned.asCBOR())
        issuerSignedCBORNameSpaces = list[0]
        issuerSignedNameSpaces = list[1]

        assertEquals(issuerSignedCBORNameSpaces, issuerSignedNameSpaces)
    }

    @Test
    fun asCBORWithOfflineRequestParameter() {
        assertEquals(issuerSignedCBOR.get("issuerAuth"), issuerSigned.asCBOR().get("issuerAuth"))

        val list = sortIssuerSignedNameSpacesData(issuerSignedCBOR, issuerSigned.asCBOR())
        issuerSignedCBORNameSpaces = list[0]
        issuerSignedNameSpaces = list[1]

        assertEquals(issuerSignedCBORNameSpaces, issuerSignedNameSpaces)
    }


}