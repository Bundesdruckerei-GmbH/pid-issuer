package de.bundesdruckerei.mdoc.kotlin.profile.mvc

import de.bundesdruckerei.mdoc.kotlin.core.Document
import de.bundesdruckerei.mdoc.kotlin.core.common.hexToByteArray
import de.bundesdruckerei.mdoc.kotlin.core.tstr
import de.bundesdruckerei.mdoc.kotlin.profile.mvc.model.EnergySource
import de.bundesdruckerei.mdoc.kotlin.profile.mvc.model.EngineInfo
import kotlinx.serialization.ExperimentalSerializationApi
import kotlinx.serialization.cbor.Cbor
import kotlinx.serialization.decodeFromByteArray
import org.junit.Assert.assertEquals
import org.junit.Assert.assertNull
import org.junit.Assert.assertTrue
import org.junit.Assert.fail
import org.junit.Test

@OptIn(ExperimentalUnsignedTypes::class, ExperimentalSerializationApi::class)
class MVCTest {

    private val mvcDocumentBytes =
        "a267646f6354797065726f72672e69736f2e373336372e312e6d56436c6973737565725369676e6564a26a697373756572417574688443a10126a1182159021d30820219308201bfa00302010202046491763b300a06082a8648ce3d040302303d310b3009060355040613024445312e302c06035504030c2542445220494143412049534f2f4945432031383031332d3520763120544553542d4f4e4c59301e170d3233303632303039343934375a170d3234303931323039343934375a303b310b3009060355040613024445312c302a06035504030c234244522044532049534f2f4945432031383031332d3520763120544553542d4f4e4c593059301306072a8648ce3d020106082a8648ce3d030107034200047bcbbdccce7b65047e871ab9fc93cbec15fbce1549c16c1af3735154233a487d1d1917fb328e74b420d0c830ccf0e0998fac701f788ddd4606dc41543f2079cca381ae3081ab300e0603551d0f0101ff04040302078030150603551d250101ff040b3009060728818c5d050102301d0603551d120416301481126d646c2d6578616d706c65406264722e646530230603551d1f041c301a3018a016a01482126d646c2e6578616d706c652e6264722e6465301f0603551d23041830168014978a573488ff09233ba01fde79839be127294069301d0603551d0e041604145fcbc262ec718ebdee9be09d5784cc22a51242c5300a06082a8648ce3d0403020348003045022021de424b4a8cbf4df3c9009769be2b0eecae8af6e327eb89e3d8e1e880ae1ec6022100df9dd6a54dbbb208fed003e555e382a10338f006d52e5e91f6ba287662bdd7665905c2d8185905bda667646f6354797065726f72672e69736f2e373336372e312e6d56436776657273696f6e63312e306c76616c6964697479496e666fa3667369676e6564c074323032342d31302d32335431363a33323a33325a6976616c696446726f6dc074323032342d31302d32335431363a33323a33325a6a76616c6964556e74696cc074323032342d31322d33305432333a30303a30305a6c76616c756544696765737473a36e6f72672e69736f2e373336372e31ad1a82db511c58206a50fda6a1b9cb44e9587565411883fc27afea0d808cc9e44c82866d3d7503c01a85b65ebe582019ffa5d6720f4a142216cf48c2b45a49e8803d51b8fb89bce6c73b3517a60a281ab70092cd5820ef736e2821a51cbd54490f64eb440a81fde241195a90a528b42b728a24300c511ace49f7b258206e685c58aee9a1f00039a1b98ce38ec21e873f4eb317e869ebdc34ac2e1c9edb1ad0ba4c095820002a2a09c4372349270d539de8db6b6fb0e6bb49caf83efc58f366314c79a47a1ad4232aa15820cf7a173c8374db4158c5cf6e8c4fef62aad2d9bb519de8097ca68dd4be6f95321ad5f8f99a582013da92278c6b83b55fbe3c5513c5f45b8d9f1f9f7aa65f6812b82c7b6711e2651ae5e4386d5820b5340debffa4e305c27c57be4be071c27bd6b8863943fd96d1b73fb3b371fc081a127291f65820f3daef95a578fbe6225e777d4e5c80dd45b723a1c0a48d9359e368da9f95562a1a16023d0a58204d8b54ad0a6c9234cc1641f057188a2e7a43a009e7c0e61631511d2d1fcea6b51a3f4d367d58209577d26cae6cc777720879e26334088c7145de64301df11b1adfdf61b385bda21a40b2aa2c5820800f143383670c24b66d4f2275bc6ccfcff6c2321a2cd91d58e19e2bf11954f01a77d31fde582092f951a590076cd4b64a306c2f771b2450290e2b7fb922a4d18c5333686dca3c6f6f72672e69736f2e32333232302e31a31afe343ad45820307ec796b89e0585afc45985db0c331d520f5f12b5a6067c6f4c16a5c63bd2fa1a13c56f3558205842fe1997b2b8b2acd06dd278fa5c52c2aae9f5f0e186fa9eec17feff6e3b341a5095abe058201be6a551b466abfe0b9703ea6817a64365615e7904a9ed18ba4b478372afcb8a716f72672e69736f2e373336372e312e4445ad1a812acccd58208a6249708ab074590acebe0576075564d1a32e1286fc8b80eae241f68789b61b1a939703fe5820f6ee30720f4a30368a1ab8604ead48dede5f3d34fe31a5920a6c41036d4da3f71a9b170913582054c3e3f9b4a47ec42d1180b9e60f661a077da4b9753b8429326889f5009d847e1aa2a08abd5820b7a50024733bd9354f798078681aa907471c6836e44b9416129f8d72c2ef6eea1ab3b6ed105820cbed2f2a9fa4e261b97fd280fefa016874e64b9b0a7e0a88ba01e13b74f45e9e1ae113736658205c3246d2e8c9ba3351776deca69a1fb67fe13d2806c764e503341f5a84b86d361aea14e5255820930e05791cbc332bcb0354fb3fb4b82b439eb8a9f2c6513ece98c9b0e4e8b9fa1af835d0d958205b2c5eab40af0872241454d40ed6baade60d95ebff1562dea73329fa2d1625411a04d441ac582083210fab0c51adea004555ddab53c31fc6a7ae647246aeab6b2557fb13fccabe1a09cdf4a458200ef4625d08bd7ffe5b490b75d629c7947b55c0bdd269a22aa083847736fe9b2c1a4ac420f35820b84f3d453c280e10f9504e194886c0ae00e6c285c18df6b6c3e475e2a2ee397f1a5b1ec1ef58202b854e5e7368c4769d873ef05acf075271f7b9066840a063780b7af719ab6f371a61ee44e55820c76ac78cf9c18cafc1a76dc3e82cd74a3d3fd900a4c1836de007792985d333206d6465766963654b6579496e666fa1696465766963654b6579a401022001215820ec0f202d0daea0ea0027721b96e73951c5aa55c06925771d56b98e1ca3a0db70225820c156c1a49c829cff92f8e34bd4dfe27798e1cb865f62bccf80c94b144a9cc68a6f646967657374416c676f726974686d675348412d323536584026ae7c33ab9b1b949569b4d3a6c855a0291fededf889573a6d8b10a20077ea12f55e7e206c8b332b91315fbe0f8a0b76abf42e3bba2f3e55345ec4cab1514bbe6a6e616d65537061636573a36e6f72672e69736f2e373336372e318dd818585fa46672616e646f6d50f49576c13f5028700099cf0fbfcb52656864696765737449441a82db511c6c656c656d656e7456616c7565614471656c656d656e744964656e74696669657276756e5f64697374696e6775697368696e675f7369676ed8185864a46672616e646f6d50c7a4b01964551b55c8b3f32376cadae16864696765737449441ad0ba4c096c656c656d656e7456616c7565695a494745422020323471656c656d656e744964656e74696669657273726567697374726174696f6e5f6e756d626572d8185862a46672616e646f6d508e636a67c587fba78137cb32604160a56864696765737449441a77d31fde6c656c656d656e7456616c7565615a71656c656d656e744964656e7469666965727818726567697374726174696f6e5f6e756d6265725f74797065d8185869a46672616e646f6d5022991feac59127c0290d43513c8fbc0a6864696765737449441a3f4d367d6c656c656d656e7456616c7565d903ec6a323032342d30352d303371656c656d656e744964656e74696669657274646174655f6f665f726567697374726174696f6ed8185870a46672616e646f6d50d523f137aa068dde6460fcda665102f26864696765737449441ace49f7b26c656c656d656e7456616c7565d903ec6a323032322d31302d323071656c656d656e744964656e746966696572781a646174655f6f665f66697273745f726567697374726174696f6ed8185876a46672616e646f6d500a854a65d4e16a49feded9ad1d1cc3376864696765737449441a85b65ebe6c656c656d656e7456616c7565d903ec6a323032352d30362d333071656c656d656e744964656e74696669657278206578706972795f646174655f746563686e6963616c5f696e7370656374696f6ed8185877a46672616e646f6d500e919949c02810530431f90eaca6cd336864696765737449441a16023d0a6c656c656d656e7456616c7565715a4d42455a42323330303032303230323471656c656d656e744964656e746966696572781d76656869636c655f6964656e74696669636174696f6e5f6e756d626572d81859011ba46672616e646f6d50ffbeddf57ee9e41aedbedf2d7f79b3e06864696765737449441a127291f66c656c656d656e7456616c756581a66d7265736964656e745f636974796b4a756e676c696e73746572707265736964656e745f616464726573736f4f7020646572204469657274203233707265736964656e745f636f756e7472796b446575747363686c616e6472676976656e5f6e616d655f756e69636f64656d48414e532d47c39c4e544845527366616d696c795f6e616d655f756e69636f6465781a564f4e2044524542454e42555343482d44414c474fe1ba9e454e747265736964656e745f706f7374616c5f636f6465643631363971656c656d656e744964656e7469666965726f726567697374657265645f75736572d81858c6a46672616e646f6d5064f6c1cf829e5b4120462bb2554105336864696765737449441a40b2aa2c6c656c656d656e7456616c7565a5646d616b65644175646967636f6c6f75727381016f636f6d6d65726369616c5f6e616d65674175646920413274747970655f617070726f76616c5f6e756d6265727265342a323030372f34362a313239332a33327476656869636c655f63617465676f72795f6e617462303171656c656d656e744964656e7469666965727262617369635f76656869636c655f696e666fd818588fa46672616e646f6d50bec18d7d0951c528c2109a14cc9d37ab6864696765737449441ae5e4386d6c656c656d656e7456616c7565a364756e6974626b677076656869636c655f6d61785f6d617373fa44bf40007819746563686e5f7065726d5f6d61785f6c6164656e5f6d617373fa44bf400071656c656d656e744964656e746966696572696d6173735f696e666fd81858b5a46672616e646f6d509e93e8787e3b308881068e9dd6475c9c6864696765737449441ad4232aa16c656c656d656e7456616c7565a364756e6974626b677823746563685f7065726d5f6d61785f746f775f6d6173735f6272616b65645f747261696cfa442280007823746563685f7065726d5f6d61785f746f775f6d6173735f756e62725f747261696c6572fa43fa000071656c656d656e744964656e74696669657271747261696c65725f6d6173735f696e666fd8185886a46672616e646f6d507a0289db780ed4680ee1e0cd8afebbac6864696765737449441ab70092cd6c656c656d656e7456616c7565a36c656e67696e655f706f77657218376e656e657267795f736f757263657381016f656e67696e655f636170616369747919055471656c656d656e744964656e7469666965726b656e67696e655f696e666fd818586da46672616e646f6d504e325064ad1b897f294b1f83fb9759286864696765737449441ad5f8f99a6c656c656d656e7456616c7565a1776e725f6f665f73656174696e675f706f736974696f6e730471656c656d656e744964656e7469666965726c73656174696e675f696e666f6f6f72672e69736f2e32333232302e3183d818585fa46672616e646f6d5087554b17bbe0c034e24d6979142f35246864696765737449441afe343ad46c656c656d656e7456616c7565d903ec6a323032342d31302d323371656c656d656e744964656e7469666965726a69737375655f64617465d8185859a46672616e646f6d508cc476e570847a8591f34c6e073d6eed6864696765737449441a13c56f356c656c656d656e7456616c756562444571656c656d656e744964656e7469666965726f69737375696e675f636f756e747279d8185884a46672616e646f6d5016b457e9dc18d2ee84f5d0452d551bde6864696765737449441a5095abe06c656c656d656e7456616c756578224c4b2053636877616c6d2d456465722d4b726569730a486f6d626572672f45667a6571656c656d656e744964656e746966696572781869737375696e675f617574686f726974795f6c6174696e31716f72672e69736f2e373336372e312e44458dd818584fa46672616e646f6d502616db2e435385be1d4bc03e3fac0bba6864696765737449441aea14e5256c656c656d656e7456616c7565f471656c656d656e744964656e7469666965726769735f6d61696ed818586aa46672616e646f6d50943058e57b8db6e9c7efaa5c9d5b11c06864696765737449441a5b1ec1ef6c656c656d656e7456616c7565735a5a2d532d302d3330352f31322d303131323471656c656d656e744964656e7469666965726f646f63756d656e745f6e756d626572d8185860a46672616e646f6d50c972c49c466403f24623b8bd5f76a6df6864696765737449441a09cdf4a46c656c656d656e7456616c7565685a5a30303131323471656c656d656e744964656e746966696572706e756d6265725f7672635f7061727432d8185860a46672616e646f6d50bd6f4edfe7ba5887a22f10dded19c80c6864696765737449441a939703fe6c656c656d656e7456616c756566537472696e6771656c656d656e744964656e7469666965727272656d61726b735f657863657074696f6e73d8185875a46672616e646f6d506b0f34425504db12373e974729d505ec6864696765737449441ab3b6ed106c656c656d656e7456616c7565d903ec6a323032342d31322d333171656c656d656e744964656e746966696572781f726567697374726174696f6e5f6e756d6265725f76616c69645f756e74696cd8185883a46672616e646f6d502fdc7255b2eb087a1d2770c45692ffdb6864696765737449441aa2a08abd6c656c656d656e7456616c756581a1706173736f63696174696f6e5f6e616d65754175746f667265756e646520466c656e736275726771656c656d656e744964656e74696669657273726567697374657265645f757365725f6e6174d818590137a46672616e646f6d50d5e69555c39e5b23724d4573458f4efb6864696765737449441a4ac420f36c656c656d656e7456616c7565ac647479706562385a67636f6c6f75727382613361306776617269616e74624c426776657273696f6e684641564a4a323135686b65795f626f64796430323030686b65795f74797065633030306b636f6c6f75725f746578748263526f7465576569c39f6c6d616e75666163747572657267417564692041476d617070726f76616c5f747970656141706d616e7566616374757265725f6b6579643035383872747970655f617070726f76616c5f64617465d903ec6a323030362d31322d3331736b65795f76617269616e745f76657273696f6e65303030303071656c656d656e744964656e7469666965727662617369635f76656869636c655f696e666f5f6e6174d8185891a46672616e646f6d50fd90a1ea0e497dbec18238a9dae23fbf6864696765737449441a04d441ac6c656c656d656e7456616c7565a278196d6173735f6f665f76656869636c655f656d7074795f6d617819050a78196d6173735f6f665f76656869636c655f656d7074795f6d696e19049771656c656d656e744964656e7469666965726d6d6173735f696e666f5f6e6174d81858aba46672616e646f6d5070de34d72c16a754cbb617bc06253b766864696765737449441a812acccd6c656c656d656e7456616c7565a4696d61785f737065656418a56d656e657267795f736f7572636564303030327472617465645f73706565645f726f746174696f6e190fa075656e67696e655f6675656c5f747970655f746578746644696573656c71656c656d656e744964656e7469666965726f656e67696e655f696e666f5f6e6174d818590108a46672616e646f6d5035bc793319e2013c8a0e65f89c345d016864696765737449441ae11373666c656c656d656e7456616c7565a76a726f61645f6e6f6973656237306c636f325f636f6d62696e656418816e656d697373696f6e5f636c617373664555524f20337073746174696f6e6172795f6e6f69736562373972656d697373696f6e5f636c6173735f6b65796430343434781973746174696f6e6172795f6e6f6973655f726f746174696f6e190bb8781c747970655f617070726f76616c5f656d697373696f6e5f636c6173737037302f3232302a323030312f3130304171656c656d656e744964656e74696669657274656e7669726f6e6d656e745f696e666f5f6e6174d81859010da46672616e646f6d508da40c1ff4477b72ca666443946b25526864696765737449441af835d0d96c656c656d656e7456616c7565a86c74697265735f617869735f316d3137352f3635523135203834546c74697265735f617869735f326d3137352f3635523135203834546d7175616e746974795f617865730271617869616c5f6c6f61645f617869735f3119036671617869616c5f6c6f61645f617869735f321902ee737175616e746974795f64726976655f617869730176746563685f617869616c5f6c6f61645f617869735f3119036676746563685f617869616c5f6c6f61645f617869735f321902ee71656c656d656e744964656e7469666965726d617869735f696e666f5f6e6174d81858aca46672616e646f6d503ed709feea3a259f8488ba82bb5a3b466864696765737449441a61ee44e56c656c656d656e7456616c7565a66977696474685f6d617819079e6977696474685f6d696e1906986a6865696768745f6d61781905f06a6865696768745f6d696e1905886a6c656e6774685f6d6178190fa06a6c656e6774685f6d696e190e2a71656c656d656e744964656e7469666965727264696d656e73696f6e5f696e666f5f6e6174d818587ca46672616e646f6d50a909adf99cfbf2d2493925583e9a90e86864696765737449441a9b1709136c656c656d656e7456616c7565781e504552534f4e454e4b52414654574147454e0a47455343484c4f5353454e71656c656d656e744964656e7469666965727576656869636c655f63617465676f72795f626f6479".hexToByteArray()


    @Test
    fun `verify() namespaces`() {
        val doc = Document.fromBytes(mvcDocumentBytes)
        doc.issuerSigned.nameSpaces?.apply {

            get(OrgIso232201.NAME)?.apply {
                assertTrue(MVC.profile.namespaces[0].verify(this, true))
            } ?: fail("Missing NameSpace OrgIso232201.")

            get(OrgIso73671.NAME)?.apply {
                assertTrue(MVC.profile.namespaces[1].verify(this, true))
            } ?: fail("Missing NameSpace OrgIso73671.")

            get(OrgIso73671DE.NAME)?.apply {
                assertTrue(MVC.profile.namespaces[2].verify(this, true))
            } ?: fail("Missing NameSpace OrgIso73671DE.")

        } ?: fail("Missing issuerSigned.nameSpaces.")
    }

    @Test
    fun `verify() OrgIso232201 ISSUING_AUTHORITY_IDENTIFIER_LATIN1`() {
        val doc = Document.fromBytes(mvcDocumentBytes)
        doc.issuerSigned.nameSpaces?.apply {

            get(OrgIso232201.NAME)?.apply {
                assertTrue(MVC.profile.namespaces[0].verify(this, true))
                val item = find {
                    OrgIso232201.ISSUING_AUTHORITY_IDENTIFIER_LATIN1.toRegex()
                        .matches(it.elementIdentifier)
                } ?: throw AssertionError("Item is missing")
                val value = Cbor.decodeFromByteArray<tstr>(item.elementValue.EncodeToBytes())
                assertEquals("LK Schwalm-Eder-Kreis\nHomberg/Efze", value)

            } ?: fail("Missing NameSpace OrgIso232201.")

        } ?: fail("Missing issuerSigned.nameSpaces.")
    }

    @Test
    fun `verify() OrgIso73671 ENGINE_INFO_IDENTIFIER energy_sources`() {
        val doc = Document.fromBytes(mvcDocumentBytes)
        doc.issuerSigned.nameSpaces?.apply {

            get(OrgIso73671.NAME)?.apply {
                assertTrue(MVC.profile.namespaces[1].verify(this, true))
                val item = find {
                    OrgIso73671.ENGINE_INFO_IDENTIFIER.toRegex()
                        .matches(it.elementIdentifier)
                } ?: throw AssertionError("Item is missing")
                val value = Cbor.decodeFromByteArray<EngineInfo>(item.elementValue.EncodeToBytes())
                assertNull(value.classOffHybridVehicleCode)
                assertEquals(1364L, value.engineCapacity)
                assertEquals(55L, value.enginePower)
                assertEquals(listOf(EnergySource.Other), value.energySources)

            } ?: fail("Missing NameSpace OrgIso73671.")

        } ?: fail("Missing issuerSigned.nameSpaces.")
    }
}